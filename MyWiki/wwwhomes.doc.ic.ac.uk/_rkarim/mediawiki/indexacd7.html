<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
	
<!-- Mirrored from wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Scar_phantoms&action=edit by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 12 Mar 2018 13:18:51 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta http-equiv="Content-Style-Type" content="text/css" />
		<meta name="generator" content="MediaWiki 1.15.1" />
		<meta name="robots" content="noindex,nofollow" />
		<meta name="keywords" content="Scar phantoms,Users" />
		<link rel="next" href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Scar_phantoms" />
		<link rel="shortcut icon" href="http://wwwhomes.doc.ic.ac.uk/favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/opensearch_desc.php" title="Rashed Karim Wiki (en)" />
		<link rel="alternate" type="application/rss+xml" title="Rashed Karim Wiki RSS Feed" href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Special:RecentChanges&amp;feed=rss" />
		<link rel="alternate" type="application/atom+xml" title="Rashed Karim Wiki Atom Feed" href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Special:RecentChanges&amp;feed=atom" />
		<title>View source - Rashed Karim Wiki</title>
		<link rel="stylesheet" href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/skins/common/shared.css?207" type="text/css" media="screen" />
		<link rel="stylesheet" href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/skins/common/commonPrint.css?207" type="text/css" media="print" />
		<link rel="stylesheet" href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/skins/monobook/main.css?207" type="text/css" media="screen" />
		<!--[if lt IE 5.5000]><link rel="stylesheet" href="/~rkarim/mediawiki/skins/monobook/IE50Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 5.5000]><link rel="stylesheet" href="/~rkarim/mediawiki/skins/monobook/IE55Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 6]><link rel="stylesheet" href="/~rkarim/mediawiki/skins/monobook/IE60Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 7]><link rel="stylesheet" href="/~rkarim/mediawiki/skins/monobook/IE70Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<link rel="stylesheet" href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=MediaWiki:Common.css&amp;usemsgcache=yes&amp;ctype=text%2Fcss&amp;smaxage=18000&amp;action=raw&amp;maxage=18000" type="text/css" />
		<link rel="stylesheet" href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=MediaWiki:Print.css&amp;usemsgcache=yes&amp;ctype=text%2Fcss&amp;smaxage=18000&amp;action=raw&amp;maxage=18000" type="text/css" media="print" />
		<link rel="stylesheet" href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=MediaWiki:Monobook.css&amp;usemsgcache=yes&amp;ctype=text%2Fcss&amp;smaxage=18000&amp;action=raw&amp;maxage=18000" type="text/css" />
		<link rel="stylesheet" href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=-&amp;action=raw&amp;maxage=18000&amp;gen=css" type="text/css" />
		<!--[if lt IE 7]><script type="text/javascript" src="/~rkarim/mediawiki/skins/common/IEFixes.js?207"></script>
		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->

		<script type= "text/javascript">/*<![CDATA[*/
		var skin = "monobook";
		var stylepath = "/~rkarim/mediawiki/skins";
		var wgArticlePath = "http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=$1";
		var wgScriptPath = "/~rkarim/mediawiki";
		var wgScript = "http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php";
		var wgVariantArticlePath = false;
		var wgActionPaths = {};
		var wgServer = "http://wwwhomes.doc.ic.ac.uk/";
		var wgCanonicalNamespace = "";
		var wgCanonicalSpecialPageName = false;
		var wgNamespaceNumber = 0;
		var wgPageName = "Scar_phantoms";
		var wgTitle = "Scar phantoms";
		var wgAction = "edit";
		var wgArticleId = "125";
		var wgIsArticle = false;
		var wgUserName = null;
		var wgUserGroups = null;
		var wgUserLanguage = "en";
		var wgContentLanguage = "en";
		var wgBreakFrames = false;
		var wgCurRevisionId = 1037;
		var wgVersion = "1.15.1";
		var wgEnableAPI = true;
		var wgEnableWriteAPI = true;
		var wgSeparatorTransformTable = ["", ""];
		var wgDigitTransformTable = ["", ""];
		var wgRestrictionEdit = [];
		var wgRestrictionMove = [];
		/*]]>*/</script>

		<script type="text/javascript" src="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/skins/common/wikibits.js?207"><!-- wikibits js --></script>
		<!-- Head Scripts -->
		<script type="text/javascript" src="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/skins/common/edit.js?207"></script>
		<script type="text/javascript" src="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/skins/common/ajax.js?207"></script>
		<script type="text/javascript" src="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=-&amp;action=raw&amp;gen=js&amp;useskin=monobook"><!-- site js --></script>
	</head>
<body class="mediawiki ltr ns-0 ns-subject page-Scar_phantoms skin-monobook">
	<div id="globalWrapper">
		<div id="column-content">
	<div id="content">
		<a name="top" id="top"></a>
				<h1 id="firstHeading" class="firstHeading">View source</h1>
		<div id="bodyContent">
			<h3 id="siteSub">From Rashed Karim Wiki</h3>
			<div id="contentSub">for <a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Scar_phantoms" title="Scar phantoms">Scar phantoms</a></div>
									<div id="jump-to-nav">Jump to: <a href="#column-one">navigation</a>, <a href="#searchInput">search</a></div>			<!-- start content -->
			<p>You do not have permission to edit this page, for the following reason:
</p>
<div class="permissions-errors">The action you have requested is limited to users in the group: <a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Rashed_Karim_Wiki:Users&amp;action=edit&amp;redlink=1" class="new" title="Rashed Karim Wiki:Users (page does not exist)">Users</a>.</div>
<p>You can view and copy the source of this page:
</p><textarea id="wpTextbox1" name="wpTextbox1" cols="80" rows="25" readonly="readonly">== Phantoms == 

Here are easier instructions that I created for Andreas [http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Creating_phantoms_for_scar here]

=== Step 1 === 
The phantoms are created from real segmented images of the left atrium. The regions of atrial wall, blood pool and background are projected and estimated (using user-defined params) from the segmented atrial surface. The software below generates this image as a ''phantom template''. Command-line code to generate a template looks like this: 
&lt;pre&gt;
createDigitalPhantom 1 _le.gipl _gad_seg.gipl phantom_template.gipl
&lt;/pre&gt;

The scars are then hand-drawn using ITK-snap on this phantom template, and save it as a separate file call it phan_scar.gipl. 

=== Step 2 === 
Grey-values are then randomly sampled from user-defined gaussian distributions for blood pool, atrial wall, background and scar (see [http://en.wikipedia.org/wiki/Box-Muller_transform Box-Muller] transforms). These grey-values are used to color the phantom-template. The following command-line code is used next to color the template: 
&lt;pre&gt;
createDigitalPhantom 2 phantom_template.gipl phan_scar.gipl phantom.gipl 140 117 280 30 
&lt;/pre&gt;

The (140,117,280,30) are values of the means of gaussian distributions for blood pool, atrial wall, scar and background respectively. The standard deviations cannot be set as a parameter, but must be changed in the code itself.

=== Step 3 === 
To run the graph-cut segmentation on these phantoms, we will use the automatic file reading feature. So we use the [http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Pre_computation_for_Graph_cuts prepareforgraphcuts] program and use the following command-line instruction: 

'''Rename phantom.gipl to _le.gipl'''. Reason: this is the phantom LE image now with the digitally produced scars
&lt;pre&gt;
preparforgraphcuts _le.gipl _gad_seg.gipl _atrial_wall.gipl _spatial_prior.gipl _blood_pool.gipl _dilated_seg.gipl
&lt;/pre&gt;

== Code ==
&lt;pre&gt;
#include &quot;irtkImage.h&quot;
#include &quot;vtkPolyData.h&quot;
#include &quot;vtkSmartPointer.h&quot;
#include &quot;vtkIdList.h&quot;
#include &lt;irtkImageFunction.h&gt;
#include &quot;vtkFloatArray.h&quot;
#include &quot;vtkCellData.h&quot;
#include &quot;vtkBoxWidget.h&quot;
#include &quot;vtkPlanes.h&quot;
#include &quot;irtkDilation.h&quot;
#include &quot;irtkErosion.h&quot;
#include &quot;irtkGaussian.h&quot;
#include &quot;irtkEMClassification.h&quot;
#include &lt;irtkEuclideanDistanceTransform.h&gt;

#include &lt;vector&gt;
#include &lt;vtkFlRenderWindowInteractor.h&gt;
#include &quot;vtkPolyDataMapper.h&quot;
#include &quot;vtkRenderer.h&quot;
#include &lt;vtkRendererCollection.h&gt;
#include &quot;vtkMarchingCubes.h&quot;
#include &quot;vtkRenderWindow.h&quot;
#include &quot;vtkPolyDataNormals.h&quot;
#include &quot;vtkImageCast.h&quot;
#include &quot;vtkStructuredPoints.h&quot;
#include &quot;vtkSmoothPolyDataFilter.h&quot;
#include &quot;vtkDecimatePro.h&quot;
#include &quot;vtkProperty.h&quot;
#include &lt;fstream&gt;
#include &lt;vtkLookupTable.h&gt;

#include &lt;ctime&gt;
#include &lt;math.h&gt;
using namespace std;

#define _ATRIAL_WALL_INDICATOR 10
#define _BLOOD_POOL_INDICATOR 20
#define _PERICARDIUM_INDICATOR 30
#define _SCAR_INDICATOR 40
#define _WIDTH_ATRIAL_WALL_PHANTOM 2	// IN PIXELS
#define _STDEV_BP_TISSUE 15
#define _STDEV_AW_TISSUE 20
#define _STDEV_BCK_TISSUE 20
#define _STDEV_SC_TISSUE 50
#define _DEFAULT_VAR_FOR_COLORING 3

/* 
* Please note that the following options: 
* ONLY NEEDED IF YOU WANT TO GENERATE PHANTOMS THAT HAVE SCARS WITH VARYING SCAR-BLOOD POOL RATIO - OPTION 4
*/
#define _SCAR_RATIO_LOW 1.1				
#define _SCAR_RATIO_HIGH 3.0
#define _AW_MEAN 140		// PUT THE MEAN ATRIAL WALL AS MEASURED FROM DE-MRI SCANS 


float unifRand()
{
    return rand() / float(RAND_MAX);
}


float unifRand(float a, float b)
{
    return (b-a)*unifRand() + a;
}

void seed()
{
    srand(time(0));
}

/************************************************************************************
*
*	Box-Muller transform for generating random numbers that follow a normal distribution 
*	From: http://www.cpp-home.com/forum/viewtopic.php?f=7&amp;t=14288
*	and also see polar-form in: http://en.wikipedia.org/wiki/Box-Muller_transform
*	Implementation found in: ftp://ftp.taygeta.com/pub/c/boxmuller.c and http://www.taygeta.com/random/boxmuller.html
*
*************************************************************************************/
float box_muller(float m, float s)	/* normal random variate generator */
{				        /* mean m, standard deviation s */
	float x1, x2, w, y1;
	static float y2;
	static int use_last = 0;

	if (use_last)		        /* use value from previous call */
	{
		y1 = y2;
		use_last = 0;
	}
	else
	{
		do {
			x1 = 2.0 * unifRand() - 1.0;
			x2 = 2.0 * unifRand() - 1.0;
			w = x1 * x1 + x2 * x2;
		} while ( w &gt;= 1.0 );

		w = sqrt( (-2.0 * log( w ) ) / w );
		y1 = x1 * w;
		y2 = x2 * w;
		use_last = 1;
	}

	return( m + y1 * s );
}

void colorPhantom(irtkRealImage* _ph_t, irtkRealImage *_ph_sc, irtkRealImage *_ph,  
				  double _bp_m, double _bp_v, 
				  double _sc_m, double _sc_v, 
				  double _aw_m, double _aw_v, 
				  double _bck_m, double _bck_v)
{
	irtkRealPixel *_ph_t_p, *_ph_p, *_ph_sc_p; 
	double bp_i, sc_i, aw_i, var, bck_i, _multp; 
	bool scarMarked = false, isRandomScar=false; 
	var = _DEFAULT_VAR_FOR_COLORING; 
	seed();			// for random number generation 
	
	_ph_t_p = _ph_t-&gt;GetPointerToVoxels(); 
	_ph_p = _ph-&gt;GetPointerToVoxels(); 
	_ph_sc_p = _ph_sc-&gt;GetPointerToVoxels(); 

	if (_sc_m == -1 &amp;&amp; _sc_v == -1) {
		isRandomScar = true;			// THIS IS OPTION 4 of the program - requesting scars to have a randomly varying SC:BP ratio 
		_sc_v = 50; 
	}

	for (int i=0;i&lt;_ph_t-&gt;GetNumberOfVoxels();i++)
	{
		if (*_ph_sc_p &gt; 0)
		{
			//sc_i = unifRand(_sc_m-(var*_sc_v), _sc_m+(var*_sc_v)); 
			if (isRandomScar) { _multp = unifRand(_SCAR_RATIO_LOW, _SCAR_RATIO_HIGH); _sc_m = _multp*_AW_MEAN; }
			sc_i = box_muller(_sc_m, sqrt(_sc_v)); 
			*_ph_p = sc_i;
			 scarMarked = true; 
		}
		else if (*_ph_t_p == _ATRIAL_WALL_INDICATOR)
		{
			//aw_i = unifRand(_aw_m-(var*_aw_v), _aw_m+(var*_aw_v)); 
			aw_i = box_muller(_aw_m, sqrt(_aw_v)); 
			*_ph_p = aw_i; 
		}
		else if (*_ph_t_p == _BLOOD_POOL_INDICATOR &amp;&amp; !scarMarked)
		{
			//bp_i = unifRand(_bp_m-(var*_bp_v), _bp_m+(var*_bp_v)); 
			bp_i = box_muller(_bp_m, sqrt(_bp_v)); 
			*_ph_p = bp_i; 
		}
		else if (*_ph_sc_p == 0 &amp;&amp; !scarMarked)
		{
			//bck_i = unifRand(_bck_m-(var*_bck_v), _bp_m+(var*_bck_v)); 
			bck_i = box_muller(_bck_m, sqrt(_bck_v)); 
			if (bck_i &gt; 0) *_ph_p = bck_i; else *_ph_p = 0;
			
		}
		 scarMarked = false; 
		_ph_p++; _ph_t_p++; _ph_sc_p++; 
		
	}

}

void getAtralWall(irtkGreyImage* _seg_im, irtkGreyImage* _aw_output)
{
	irtkGreyImage temp, dilate, erode; 
	irtkGreyPixel* temp_p, *dilate_p, *erode_p, *seg_p, *aw_p; 

	temp =* _seg_im; 
	dilate =* _seg_im; 
	erode =* _seg_im; 
	

	irtkDilation&lt;irtkGreyPixel&gt; dilation; 
	irtkErosion&lt;irtkGreyPixel&gt; erosion;
	erosion.SetInput(&amp;erode); 
	erosion.SetOutput(&amp;erode);

	for (int i=0;i&lt;_WIDTH_ATRIAL_WALL_PHANTOM;i++)
	{
		cout &lt;&lt; &quot;eroding .. &quot; &lt;&lt; i &lt;&lt; endl;
		erosion.Run();						// we do erosion followed by dilation, however, we dont use the same number of iterations for
	}										// each. 

	dilation.SetInput(&amp;dilate);
	dilation.SetOutput(&amp;dilate);
	
	for (int i=0;i&lt;_WIDTH_ATRIAL_WALL_PHANTOM;i++)
	{
		cout &lt;&lt; &quot;dilating .. &quot; &lt;&lt; i &lt;&lt; endl;
		dilation.Run();
	}
	
	temp_p = temp.GetPointerToVoxels(); 
	dilate_p = dilate.GetPointerToVoxels(); 
	erode_p = erode.GetPointerToVoxels(); 
	seg_p = _seg_im-&gt;GetPointerToVoxels(); 
	aw_p = _aw_output-&gt;GetPointerToVoxels(); 

	for (int i=0; i&lt;temp.GetNumberOfVoxels(); i++)
	{
		if ((*seg_p &gt; 0 &amp;&amp; *erode_p == 0) || (*seg_p == 0 &amp;&amp; *dilate_p &gt; 0) )
		{
			*aw_p = 1; 
		}
		else 
		{
			*aw_p = 0; 
		}
		temp_p++; dilate_p++; seg_p++; erode_p++; aw_p++;
	}
	
}

/**
*	Generates the phantom template - template includes aresa that are labelled as blood pool and atrial wall. Background is labelled with label = 0
*	It is on these templates that the scars (phantom scars) are hand-drawn using an image tool such as ITK-snap. However, when scars are added to this template
*	it still remains a 'template'. It becomes the real phantom when the  colorPhantom function distributes grey values from a user-defined range 
*	in a random fashion. 
*/
void makePhantomTemplate(irtkGreyImage* _seg_im, irtkGreyImage* _aw_im, irtkRealImage* _ph_t)
{
	irtkRealPixel* ph_t_p;
	irtkGreyPixel* seg_p, *aw_p;
	//irtkGreyPixel* _seg_p; 
	ph_t_p = _ph_t-&gt;GetPointerToVoxels(); 
	seg_p = _seg_im-&gt;GetPointerToVoxels(); 
	aw_p = _aw_im-&gt;GetPointerToVoxels(); 

	for (int i=0;i&lt;_ph_t-&gt;GetNumberOfVoxels();i++)
	{
		if (*seg_p &gt; 0)
			*ph_t_p =  _BLOOD_POOL_INDICATOR; 
		else if (*aw_p &gt; 0)
			*ph_t_p = _ATRIAL_WALL_INDICATOR;
		else 
			*ph_t_p = 0; 
		ph_t_p++; seg_p++; aw_p++;
	}

}

int main(int argc, char **argv)
{
	char* filename1, *filename2, *filename3, *filename4, *filename5;
	 
	irtkRealImage lge_im,  bp_im, ph_t_im, ph_im, ph_sc_im; 
	irtkGreyImage seg_im, aw_im;
	double bp_m, sc_m, aw_m, bck_m, sc_stdev;
	
	int option; 

	if (argc &gt; 1) option = atoi(argv[1]); 
	else 
	{
		std::cerr &lt;&lt; &quot;Welcome to the RK Phantom Creator program, Rashed Karim (c) 2011\n\nERROR MSG: You have issued no parameters to the program. &quot;
			&quot;The program requires parameters that will allow you to select various options.&quot; 
			&quot;\n\nThe different options are accessible using the following command issued from the command-line:\ncreatePhantom.exe &lt;option-number&gt;\n\nOptions available:\n&quot;
			&quot;1 - Generate phantom template\n2 - Distribute intensities to an existing phantom template\n3 - Similar to option 2, but with variable std. dev for scar intensities&quot;
			&quot;4 - Similar to option 2 and 3, except with varying scar-bloodpool ratio possible\n\nTo find out the parameters necessary within the different options &quot;
			&quot;type the following command:\ncreatePhantom.exe &lt;option-number&gt;&quot; &lt;&lt; endl;
		exit(0); 
	}
	argc--; 
	argv++; 
	
	if (option == 1)
	{
		// option requested to generate a phantom template
		if (argc &lt; 4)
		{
			std::cerr &lt;&lt; &quot;Usage: &quot; &lt;&lt; argv[0] &lt;&lt; &quot; &lt;late_enhancement_scan&gt; &lt;la_Segmentation&gt; &lt;output_phantom_template_file&gt;&quot; &lt;&lt; std::endl;
		}
		else
		{
			filename1 = argv[1]; argc--; argv++; 
			filename2 = argv[1]; argc--; argv++; 
			filename5 = argv[1]; argc--; argv++; 
			lge_im.Read(filename1); seg_im.Read(filename2); 
			ph_t_im = lge_im; 
		

			aw_im = seg_im; 
			getAtralWall(&amp;seg_im, &amp;aw_im); 
			makePhantomTemplate(&amp;seg_im, &amp;aw_im, &amp;ph_t_im);
			ph_t_im.Write(filename5); 
		}
		
	}
	else if (option == 2)
	{
		// option requested to color a phantom template 
		if (argc &lt; 6)
		{
			std::cerr &lt;&lt; &quot;Usage: &quot; &lt;&lt; argv[0] &lt;&lt; &quot; &lt;phantom_template&gt; &lt;phantom_scar&gt; &lt;phantom_output&gt; &lt;bp_m&gt; &lt;aw_m&gt; &lt;sc_m&gt; &lt;bck_m&gt;\n\n&lt;bp_m&gt; - mean of blood pool (intensity values of the blood pool are distributed assuming a Gaussian distribution with variance set in program)&quot; &lt;&lt; std::endl;
		}
		else
		{
			filename1 = argv[1]; argc--; argv++;
			filename2 = argv[1]; argc--; argv++;
			filename3 = argv[1]; argc--; argv++; 
									
			ph_t_im.Read(filename1); 
			ph_sc_im.Read(filename2);
			ph_im = ph_t_im;

			bp_m = atof(argv[1]); argc--; argv++; 
			aw_m = atof(argv[1]); argc--; argv++; 
			sc_m = atof(argv[1]); argc--; argv++; 
			bck_m = atof(argv[1]); argc--; argv++; 

			colorPhantom(&amp;ph_t_im, &amp;ph_sc_im, &amp;ph_im, bp_m, _STDEV_BP_TISSUE, sc_m, _STDEV_SC_TISSUE, aw_m, _STDEV_AW_TISSUE, bck_m, _STDEV_BCK_TISSUE);
			ph_im.Write(filename3);

		}
	}
	else if (option == 3)
	{
		// option requested to color a phantom template using varying std. dev for scar
		if (argc &lt; 6)
		{
			std::cerr &lt;&lt; &quot;Usage: &quot; &lt;&lt; argv[0] &lt;&lt; &quot; &lt;phantom_template&gt; &lt;phantom_scar&gt; &lt;phantom_output&gt; &lt;bp_m&gt; &lt;aw_m&gt; &lt;sc_m&gt; &lt;bck_m&gt; &lt;sc_stdev&gt;\n\n&lt;bp_m&gt; - mean of blood pool (intensity values of the blood pool are distributed assuming a Gaussian distribution with variance set in program)&quot; &lt;&lt; std::endl;
		}
		else
		{
			filename1 = argv[1]; argc--; argv++;
			filename2 = argv[1]; argc--; argv++;
			filename3 = argv[1]; argc--; argv++; 
									
			ph_t_im.Read(filename1); 
			ph_sc_im.Read(filename2);
			ph_im = ph_t_im;

			bp_m = atof(argv[1]); argc--; argv++; 
			aw_m = atof(argv[1]); argc--; argv++; 
			sc_m = atof(argv[1]); argc--; argv++; 
			bck_m = atof(argv[1]); argc--; argv++; 
			sc_stdev = atof(argv[1]); argc--; argv++; 
			
			colorPhantom(&amp;ph_t_im, &amp;ph_sc_im, &amp;ph_im, bp_m, _STDEV_BP_TISSUE, sc_m, sc_stdev, aw_m, _STDEV_AW_TISSUE, bck_m, _STDEV_BCK_TISSUE);
			ph_im.Write(filename3);

		} 
	}
	else if (option == 4)
	{
		// option requested to color a phantom template using varying mean for scar (so a single phantom can have scars across randomly varying SC:BP ratios)
		if (argc &lt; 5)
		{
			std::cerr &lt;&lt; &quot;\nYou have requested option 4 to color a phantom template using varying mean for scar (so a single phantom can have scars across randomly varying SC:BP ratios)\n\nUsage: &quot; &lt;&lt; argv[0] &lt;&lt; &quot; &lt;phantom_template&gt; &lt;phantom_scar&gt; &lt;phantom_output&gt; &lt;bp_m&gt; &lt;aw_m&gt; &lt;bck_m&gt;\n\n&lt;bp_m&gt; - mean of blood pool (intensity values of the blood pool are distributed assuming a Gaussian distribution with variance set in program)&quot; &lt;&lt; std::endl;
		}
		else
		{
			filename1 = argv[1]; argc--; argv++;
			filename2 = argv[1]; argc--; argv++;
			filename3 = argv[1]; argc--; argv++; 
									
			ph_t_im.Read(filename1); 
			ph_sc_im.Read(filename2);
			ph_im = ph_t_im;

			bp_m = atof(argv[1]); argc--; argv++; 
			aw_m = atof(argv[1]); argc--; argv++; 
			bck_m = atof(argv[1]); argc--; argv++; 
			
			
			colorPhantom(&amp;ph_t_im, &amp;ph_sc_im, &amp;ph_im, bp_m, _STDEV_BP_TISSUE, -1,-1, aw_m, _STDEV_AW_TISSUE, bck_m, _STDEV_BCK_TISSUE);
			ph_im.Write(filename3);

		} 
	}
	


}&lt;/pre&gt;

== Running the phantom test in batch mode == 
The phantom scars are assigned grey-values from a '''random''' sampling of a normal distribution specified by the user (i.e. mean and variance). Every time a phantom is created it is unique as the scar intensity values are random samples. To do a thorough analysis, it is good to generate N different phantoms for each user-defined scar intensity normal distribution.  

So in this example, I am changing the scar intensity means (112, 126, 140, ...) where actually I am altering the SCAR:Blood-pool ratio from 0.8 to 2.0. For each grey-value, I generate 100 different random phantoms where the scar intensity distribution is centered around that grey-value. The [http://en.wikipedia.org/wiki/Dice's_coefficient dice] is computed in each run of the phantom and written to a text-file. On average it takes about 45 secs per phantom (on a 2.2 Ghz Mac/PC), so this batch file takes about 18 hours to complete. NOTE: random phantoms only mean the same anatomy but different grey-value intensities for scar: 

&lt;pre&gt;

for %%y in (112 126 140 154 168 182 196 210 224 238 252 266 280 420 560) do (
	echo &quot;Scar intensity %%y&quot; &gt;&gt; output.txt
	for /l %%x in (1,1,100) do (
		test2 2 phantom_template.gipl phan_scar.gipl _le.gipl 140 117 %%y 30
		test1 _le.gipl _gad_seg.gipl _atrial_wall.gipl _spatial_prior.gipl _blood_pool.gipl 
		scar3d . x x 
		test3 _gc_seg_out.gipl phan_scar.gipl 100 1 output.txt 
	)
)
&lt;/pre&gt;

== Phantom training and testing ==

The strategy was to fix the atrial wall, blood pool intensities. However, fixing them only means that their intensities were sampled  ''randomly'' from a ''fixed'' gaussian with these means and std. deviation: 
* Atrial wall = (117,20) = (mean , standard deviation) 
* blood pool = (140, 15)

The scar intensities were varied. So we varied the SC:BP (scar to blood-pool) ratios from 0.8 to 4.0 in increments of 0.1 (though 3.0 to 4.0 is a little unrealistic in the scope of MRI images). Phantoms were generated across the whole spectrum and the scar model was trained on these. The scar model was also trained on specific bands such as 1.0 to 1.2, etc.

In the phantom training folder on PC, here is the manual for the output.txt files: 
&lt;pre&gt;

Each folder represents a different specturm, SCar:blood pool ratio. 

So for example 10_to_12 means the scar model was only trained on phantoms with sc:BP ratio ranging from 1.0 to 1.2. Note blood pool mean was set fixed to 140

In each of these folder yuo will find output3.txt. This is the result of the dice co-effieicents that were output by the automatic segmentation algorithm. The dice is between the ground-truth contained in phan_Scar.gipl and the output from the algorithm. 

SO in output.txt, 
&lt;scar intensity xxx&gt; - where xxx is the mean intensity and variance (of SCAR) was set fixed to 50 of the phantoms that are generated on the fly for testing. 
The four numbers that follow on each line thereafter are the following: 
&lt;dice-coefficeint&gt; &lt;total voxels in auto segmentation&gt; &lt;total voxels in ground truth&gt; &lt;total oxels in overlap of ground truth and auto segmentation&gt; 


&lt;/pre&gt;</textarea><div class='templatesUsed'>

</div>
<p>Return to <a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Scar_phantoms" title="Scar phantoms">Scar phantoms</a>.</p>
<div class="printfooter">
Retrieved from "<a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Scar_phantoms">http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Scar_phantoms</a>"</div>
						<!-- end content -->
						<div class="visualClear"></div>
		</div>
	</div>
		</div>
		<div id="column-one">
	<div id="p-cactions" class="portlet">
		<h5>Views</h5>
		<div class="pBody">
			<ul>
	
				 <li id="ca-nstab-main" class="selected"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Scar_phantoms" title="View the content page [c]" accesskey="c">Page</a></li>
				 <li id="ca-talk" class="new"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Talk:Scar_phantoms&amp;action=edit&amp;redlink=1" title="Discussion about the content page [t]" accesskey="t">Discussion</a></li>
				 <li id="ca-viewsource" class="selected"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Scar_phantoms&amp;action=edit" title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></li>
				 <li id="ca-history"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Scar_phantoms&amp;action=history" title="Past revisions of this page [h]" accesskey="h">History</a></li>			</ul>
		</div>
	</div>
	<div class="portlet" id="p-personal">
		<h5>Personal tools</h5>
		<div class="pBody">
			<ul>
				<li id="pt-anonuserpage"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=User:159.92.151.128" title="The user page for the ip you&#039;re editing as [.]" accesskey="." class="new">159.92.151.128</a></li>
				<li id="pt-anontalk"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=User_talk:159.92.151.128" title="Discussion about edits from this IP address [n]" accesskey="n" class="new">Talk for this IP</a></li>
				<li id="pt-anonlogin"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Special:UserLogin&amp;returnto=Scar_phantoms" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-logo">
		<a style="background-image: url(http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/images/myWikiLogo.gif);" href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Research_Wiki" title="Visit the main page [z]" accesskey="z"></a>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
	<div class='generated-sidebar portlet' id='p-navigation'>
		<h5>Navigation</h5>
		<div class='pBody'>
			<ul>
				<li id="n-mainpage-description"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Research_Wiki">Main Page</a></li>
				<li id="n-Home"><a href="http://www.doc.ic.ac.uk/~rkarim/">Home</a></li>
				<li id="n-currentevents"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Rashed_Karim_Wiki:Current_events" title="Find background information on current events">Current events</a></li>
				<li id="n-recentchanges"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Special:RecentChanges" title="The list of recent changes in the wiki [r]" accesskey="r">Recent changes</a></li>
				<li id="n-randompage"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Special:Random" title="Load a random page [x]" accesskey="x">Random page</a></li>
				<li id="n-help"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Help:Contents" title="The place to find out">Help</a></li>
			</ul>
		</div>
	</div>
	<div id="p-search" class="portlet">
		<h5><label for="searchInput">Search</label></h5>
		<div id="searchBody" class="pBody">
			<form action="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php" id="searchform"><div>
				<input type='hidden' name="title" value="Special:Search"/>
				<input id="searchInput" name="search" type="text" title="Search Rashed Karim Wiki [f]" accesskey="f" value="" />
				<input type='submit' name="go" class="searchButton" id="searchGoButton"	value="Go" title="Go to a page with this exact name if exists" />&nbsp;
				<input type='submit' name="fulltext" class="searchButton" id="mw-searchButton" value="Search" title="Search the pages for this text" />
			</div></form>
		</div>
	</div>
	<div class="portlet" id="p-tb">
		<h5>Toolbox</h5>
		<div class="pBody">
			<ul>
				<li id="t-whatlinkshere"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Special:WhatLinksHere/Scar_phantoms" title="List of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
				<li id="t-recentchangeslinked"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Special:RecentChangesLinked/Scar_phantoms" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
<li id="t-specialpages"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Special:SpecialPages" title="List of all special pages [q]" accesskey="q">Special pages</a></li>
			</ul>
		</div>
	</div>
		</div><!-- end of the left (by default at least) column -->
			<div class="visualClear"></div>
			<div id="footer">
				<div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" /></a></div>
			<ul id="f-list">
					<li id="privacy"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Rashed_Karim_Wiki:Privacy_policy" title="Rashed Karim Wiki:Privacy policy">Privacy policy</a></li>
					<li id="about"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Rashed_Karim_Wiki:About" title="Rashed Karim Wiki:About">About Rashed Karim Wiki</a></li>
					<li id="disclaimer"><a href="http://wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Rashed_Karim_Wiki:General_disclaimer" title="Rashed Karim Wiki:General disclaimer">Disclaimers</a></li>
			</ul>
		</div>
</div>

		<script type="text/javascript">if (window.runOnloadHook) runOnloadHook();</script>
<!-- Served in 0.469 secs. --></body>
<!-- Mirrored from wwwhomes.doc.ic.ac.uk/~rkarim/mediawiki/index.php?title=Scar_phantoms&action=edit by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 12 Mar 2018 13:18:51 GMT -->
</html>
